{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///home/deepakps/Documents/GitHub/AI_fitness_coach/backend/gemini.ts"],"sourcesContent":["import { Buffer } from \"buffer\"\nimport type { PlanContent } from \"@/lib/plan-types\"\n\nconst GEMINI_MODEL = process.env.GEMINI_MODEL?.trim() || \"gemini-2.5-flash\"\nconst GEMINI_BASE = \"https://generativelanguage.googleapis.com/v1beta\"\n\nconst DEFAULT_MOTIVATION = \"Your plan is ready. Stay consistent and you'll see results.\"\n\nfunction buildPrompt(body: Record<string, unknown>) {\n  const lines = [\n    \"You are an expert fitness coach and dietitian.\",\n    \"Respond ONLY with valid JSON. Do not include code fences, markdown, or prose.\",\n    \"Ensure all keys and string values are enclosed in double quotes.\",\n    \"Do not use trailing commas.\",\n    \"Fields: workouts (array of {name, sets, reps, rest, focus, imagePrompt}), meals (array of {meal, items, calories, protein, carbs, fats, imagePrompt}), tips (array of strings), motivation (single string).\",\n    \"Keep workouts 4-6 items, meals 4 items (breakfast, lunch, snack, dinner).\",\n    \"Tailor to the user's goals, level, location, dietary preferences, and medical notes.\",\n    `User data: ${JSON.stringify(body)}`,\n  ]\n  return lines.join(\"\\n\")\n}\n\nfunction buildTipsPrompt(body: Record<string, unknown>, plan?: Pick<PlanContent, \"workouts\" | \"meals\">) {\n  const lines = [\n    \"You are a motivational fitness coach.\",\n    \"Respond ONLY with JSON containing { \\\"tips\\\": string[], \\\"motivation\\\": string }.\",\n    \"Tips must be actionable (max 2 sentences each). Motivation should be a single uplifting quote.\",\n    `User data: ${JSON.stringify(body)}`,\n  ]\n  if (plan) {\n    lines.push(`Current plan context: ${JSON.stringify(plan)}`)\n  }\n  return lines.join(\"\\n\")\n}\n\nconst extractJson = (text: string): string | null => {\n  const fenced = text.match(/```json([\\s\\S]*?)```/i)\n  if (fenced?.[1]) return fenced[1].trim()\n  const braces = text.match(/\\{[\\s\\S]*\\}/)\n  if (braces?.[0]) return braces[0].trim()\n  return null\n}\n\nconst repairJson = (text: string): string => {\n  // 1. Remove markdown code blocks\n  let cleaned = text.replace(/```json/gi, \"\").replace(/```/g, \"\").trim()\n  \n  // 2. Attempt to fix common JSON syntax errors\n  // Replace single quotes with double quotes for keys/values, but be careful about apostrophes in text\n  // This is hard to do perfectly with regex. \n  // Instead, let's focus on the structure.\n  \n  // If the model returns \"key\": \"value\" \"key2\": \"value\" (missing comma)\n  // We can try to insert commas between value and key.\n  // Look for \" (end of string) followed by whitespace/newlines then \" (start of key)\n  cleaned = cleaned.replace(/\"\\s+(?=\")/g, '\", ')\n  \n  // If the model returns number followed by key without comma: 123 \"key\"\n  cleaned = cleaned.replace(/(\\d+)\\s+(?=\")/g, '$1, ')\n\n  // If the model returns boolean followed by key without comma: true \"key\"\n  cleaned = cleaned.replace(/(true|false)\\s+(?=\")/g, '$1, ')\n\n  // Remove trailing commas before closing braces/brackets\n  cleaned = cleaned.replace(/,\\s*([\\]}])/g, '$1')\n\n  return cleaned\n}\n\nasync function requestGemini(prompt: string) {\n  if (!process.env.GEMINI_API_KEY) {\n    throw new Error(\"GEMINI_API_KEY is not set\")\n  }\n\n  const geminiRes = await fetch(\n    `${GEMINI_BASE}/models/${encodeURIComponent(GEMINI_MODEL)}:generateContent?key=${process.env.GEMINI_API_KEY}`,\n    {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify({\n        contents: [\n          {\n            role: \"user\",\n            parts: [{ text: prompt }],\n          },\n        ],\n        generationConfig: {\n          temperature: 0.8,\n          maxOutputTokens: 8192,\n          responseMimeType: \"application/json\",\n        },\n      }),\n    },\n  )\n\n  if (!geminiRes.ok) {\n    const errorText = await geminiRes.text()\n    throw new Error(errorText || \"Gemini request failed\")\n  }\n\n  const geminiJson = (await geminiRes.json()) as any\n  const parts = geminiJson?.candidates?.[0]?.content?.parts\n  const rawText: string | undefined = Array.isArray(parts)\n    ? parts\n        .map((p: any) => {\n          if (typeof p?.text === \"string\") return p.text\n          if (p?.inlineData?.data) {\n            try {\n              const buf = Buffer.from(p.inlineData.data, \"base64\").toString(\"utf8\")\n              return buf\n            } catch {\n              return \"\"\n            }\n          }\n          if (p?.json) {\n            try {\n              return JSON.stringify(p.json)\n            } catch {\n              return \"\"\n            }\n          }\n          return \"\"\n        })\n        .join(\"\\n\")\n        .trim()\n    : undefined\n  if (!rawText) {\n    throw new Error(\"No content returned from Gemini\")\n  }\n\n  return rawText\n}\n\nfunction parseJsonPayload<T>(rawText: string): T {\n  try {\n    const cleaned = extractJson(rawText) ?? rawText.trim()\n    return JSON.parse(cleaned) as T\n  } catch (err) {\n    const repaired = repairJson(rawText)\n    return JSON.parse(repaired) as T\n  }\n}\n\nexport async function generatePlanFromGemini(body: Record<string, unknown>): Promise<PlanContent> {\n  const prompt = buildPrompt(body)\n  const rawText = await requestGemini(prompt)\n  const parsed = parseJsonPayload<PlanContent>(rawText)\n\n  return {\n    workouts: parsed.workouts || [],\n    meals: parsed.meals || [],\n    tips: parsed.tips || [],\n    motivation: parsed.motivation || DEFAULT_MOTIVATION,\n  }\n}\n\nexport async function generateTipsFromGemini(\n  body: Record<string, unknown>,\n  plan?: Pick<PlanContent, \"workouts\" | \"meals\">,\n): Promise<{ tips: string[]; motivation: string }> {\n  const prompt = buildTipsPrompt(body, plan)\n  const rawText = await requestGemini(prompt)\n  const parsed = parseJsonPayload<{ tips?: string[]; motivation?: string }>(rawText)\n  return {\n    tips: parsed.tips || [],\n    motivation: parsed.motivation || DEFAULT_MOTIVATION,\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 204, "column": 0}, "map": {"version":3,"sources":["file:///home/deepakps/Documents/GitHub/AI_fitness_coach/app/api/generate-plan/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { generatePlanFromGemini } from \"@/backend/gemini\"\n\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json()\n    const plan = await generatePlanFromGemini(body)\n    return NextResponse.json(plan)\n  } catch (error) {\n    console.error(\"/api/generate-plan error\", error)\n    return NextResponse.json({ error: (error as Error).message || \"Unexpected error\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,OAAO,MAAM,IAAA,6IAAsB,EAAC;QAC1C,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,AAAC,MAAgB,OAAO,IAAI;QAAmB,GAAG;YAAE,QAAQ;QAAI;IACpG;AACF"}}]
}